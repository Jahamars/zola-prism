{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block htmltitle %}
{{ page.title }} - {{ config.title }}
{% endblock htmltitle %}

{% block content %}
<div id="content">
    {% if not page.extra.no_header %}
    <div class="hero">
        <h1>{{ page.title }}</h1>

        <div class="hero-meta">

            {% if page.date %}
            <span>{{ page.date | date(format="%b %d, %Y") }}</span>
            {% endif %}

            {% if page.reading_time and config.extra.show_reading_time %}
            <span>·</span>
            <span>{{ page.reading_time }} min read</span>
            {% endif %}

            {% if page.word_count and config.extra.show_word_count %}
            <span>·</span>
            <span>{{ page.word_count }} words</span>
            {% endif %}
        </div>

        {% if page.taxonomies.tags %}
        <div class="tags-cloud">
            {% for tag in page.taxonomies.tags %}
            <a href="{{ get_taxonomy_url(kind='tags', name=tag) }}" class="tag">#{{ tag }}</a>
            {% endfor %}
        </div>
        {% endif %}

        {% if page.taxonomies.authors %}
        <div class="authors-list">
            By
            {% for author in page.taxonomies.authors %}
            <a href="{{ get_taxonomy_url(kind='authors', name=author) }}" class="author-link">{{ author }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if config.extra.show_toc and page.toc and page.extra.toc | default(value=true) %}
    <nav class="table-of-contents" aria-label="Table of contents">
        <div class="toc-header">
            <span class="toc-title">Contents</span>
        </div>
        <ul class="toc-list">
            {% for entry in page.toc %}
            <li class="toc-item">
                <a href="#{{ entry.id }}" class="toc-link" data-target="{{ entry.id }}">{{ entry.title }}</a>
                {% if entry.children %}
                <ul class="toc-list">
                    {% for child in entry.children %}
                    <li class="toc-item toc-item--nested">
                        <a href="#{{ child.id }}" class="toc-link toc-link--nested" data-target="{{ child.id }}">{{ child.title }}</a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </nav>

    <script>
    'use strict';
    
    (function initTableOfContents() {
        const toc = document.querySelector('.table-of-contents');
        const links = document.querySelectorAll('.toc-link');
        
        if (!links.length) return;

        requestAnimationFrame(() => {
            toc.classList.add('visible');
        });

        const headingMap = new Map();
        links.forEach(link => {
            const targetId = link.dataset.target;
            const heading = document.getElementById(targetId);
            if (heading) {
                headingMap.set(targetId, { link, heading });
            }
        });

        const observerOptions = {
            rootMargin: '-40% 0px -50% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    links.forEach(link => link.classList.remove('toc-link--active'));
                    
                    const targetId = entry.target.id;
                    const item = headingMap.get(targetId);
                    if (item) {
                        item.link.classList.add('toc-link--active');
                        
                        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                        item.link.scrollIntoView({ 
                            behavior: prefersReducedMotion ? 'auto' : 'smooth',
                            block: 'nearest',
                            inline: 'nearest'
                        });
                    }
                }
            });
        }, observerOptions);

        headingMap.forEach(({ heading }) => {
            observer.observe(heading);
        });

        window.addEventListener('beforeunload', () => {
            observer.disconnect();
        });
    })();
    </script>
    {% endif %}

    <article>
        {{ page.content | safe }}
    </article>

    {% if config.extra.comments and not page.extra.no_comments %}
    <hr class="comments-divider" />
    {% include "comments.html" %}
    {% endif %}
</div>
{% endblock content %}
